<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/backend/dunzomanagement/project_app/views.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/backend/dunzomanagement/project_app/views.py" />
              <option name="originalContent" value="import json&#10;from django.contrib.auth.decorators import login_required&#10;from django.db import connection&#10;from django.http import JsonResponse&#10;from django.utils.decorators import method_decorator&#10;from django.views.decorators.csrf import csrf_exempt&#10;from django.views import View&#10;from django.apps import apps&#10;&#10;from .models import *&#10;User = apps.get_model(app_label='user_app', model_name='User')&#10;Task = apps.get_model(app_label='task_app', model_name='Task')&#10;&#10;def decode_body(request):&#10;    try:&#10;        return json.loads(request.body.decode('utf-8'))&#10;    except json.JSONDecodeError:&#10;        return {}&#10;&#10;@method_decorator(csrf_exempt, name='dispatch')&#10;class ProjectView(View):&#10;    def dispatch(self, request, *args, **kwargs):&#10;        if not request.user.is_authenticated:&#10;            return JsonResponse({'success': False, 'error': 'Unauthorized'}, status=401)&#10;        return super().dispatch(request, *args, **kwargs)&#10;    def get(self, request):&#10;        user_id = request.user.pk&#10;&#10;        filter_type = request.GET.get('filter', 'Active')&#10;&#10;        # Validate filter to prevent SQL issues (optional but good practice)&#10;        valid_filters = ['Active', 'Archived', 'Complete', 'All', 'Leader']&#10;        if filter_type not in valid_filters:&#10;            filter_type = 'Active'&#10;&#10;        try:&#10;            with connection.cursor() as cursor:&#10;                # Call the Stored Procedure&#10;                cursor.callproc(&quot;get_user_projects&quot;, [user_id, filter_type])&#10;&#10;                # Fetch the JSON result&#10;                projects_data = cursor.fetchone()[0]&#10;&#10;                return JsonResponse({'success': True, 'projects': projects_data})&#10;&#10;        except Exception as e:&#10;            print(f&quot;Get Projects Error: {e}&quot;)&#10;            return JsonResponse({'success': False, 'error': 'Internal Server Error'}, status=500)&#10;    def post(self, request):&#10;        data = decode_body(request)&#10;&#10;        # Extract data from the request body&#10;        user_id = request.user.pk&#10;        title = data.get('title')&#10;        description = data.get('description', '')  # Default to empty string if missing&#10;        start_date = data.get('start_date')&#10;        end_date = data.get('end_date')&#10;&#10;        # Basic Validation&#10;        if not title or not start_date or not end_date:&#10;            return JsonResponse({&#10;                'success': False,&#10;                'error': 'Title, Start Date, and End Date are required.'&#10;            }, status=400)&#10;&#10;        try:&#10;            with connection.cursor() as cursor:&#10;                # Signature: (p_user_id, p_title, p_description, p_start_date, p_end_date)&#10;                cursor.callproc(&#10;                    &quot;create_project&quot;,&#10;                    [user_id, title, description, start_date, end_date]&#10;                )&#10;&#10;                # Fetch the returned Project ID&#10;                new_project_id = cursor.fetchone()[0]&#10;&#10;                return JsonResponse({&#10;                    'success': True,&#10;                    'message': 'Project created successfully',&#10;                    'project_id': new_project_id&#10;                }, status=201)&#10;&#10;        except Exception as e:&#10;            # Log error for debugging (optional)&#10;            print(f&quot;Create Project Error: {e}&quot;)&#10;            return JsonResponse({'success': False, 'error': str(e)}, status=500)&#10;    def delete(self, request):&#10;        user_id = request.user.pk&#10;&#10;        data = decode_body(request)&#10;        project_id = data.get('project_id')&#10;&#10;        if not project_id:&#10;            return JsonResponse({'success': False, 'error': 'Project ID is required'}, status=400)&#10;&#10;        try:&#10;            # 1. Security Check: Only the 'Leader' can delete&#10;            # We check if a membership exists that matches: User + Project + Role='Leader'&#10;            is_leader = ProjectMembership.objects.filter(&#10;                project_id=project_id,&#10;                user_id=user_id,&#10;                role='Leader'&#10;            ).exists()&#10;&#10;            if not is_leader:&#10;                return JsonResponse({&#10;                    'success': False,&#10;                    'error': 'Permission denied. Only the Leader can delete this project.'&#10;                }, status=403)&#10;&#10;            # 2. Perform Delete&#10;            Project.objects.get(pk=project_id).delete()&#10;&#10;            return JsonResponse({'success': True, 'message': 'Project deleted successfully'})&#10;&#10;        except Project.DoesNotExist:&#10;            return JsonResponse({'success': False, 'error': 'Project not found'}, status=404)&#10;        except Exception as e:&#10;            return JsonResponse({'success': False, 'error': str(e)}, status=500)&#10;&#10;@method_decorator(csrf_exempt, name='dispatch')&#10;class ProjectDetailView(View):&#10;    def dispatch(self, request, *args, **kwargs):&#10;        if not request.user.is_authenticated:&#10;            return JsonResponse({'success': False, 'error': 'Unauthorized'}, status=401)&#10;        return super().dispatch(request, *args, **kwargs)&#10;    # get project details&#10;    def get(self, request):&#10;        project_id = request.GET.get('project_id')&#10;        user_id = request.user.pk&#10;&#10;        if not project_id:&#10;            return JsonResponse({'success': False, 'error': 'Project ID is required.'}, status=400)&#10;&#10;        try:&#10;            with connection.cursor() as cursor:&#10;                # Call Stored Procedure&#10;                # Signature: (p_project_id, p_user_id)&#10;                cursor.callproc(&#10;                    &quot;get_project_details&quot;,&#10;                    [project_id, user_id]&#10;                )&#10;&#10;                # Fetch the single JSON blob result&#10;                result = cursor.fetchone()[0]&#10;&#10;                # Check status code based on result success&#10;                if result.get('success'):&#10;                    return JsonResponse(result)&#10;                else:&#10;                    # Determine error code (403 for Unauthorized, 404 for Not Found)&#10;                    error_msg = result.get('error', '')&#10;                    status_code = 403 if 'Unauthorized' in error_msg else 404&#10;                    return JsonResponse(result, status=status_code)&#10;&#10;        except Exception as e:&#10;            print(f&quot;Get Project Details Error: {e}&quot;)&#10;            return JsonResponse({'success': False, 'error': 'Internal Server Error'}, status=500)&#10;    # update project details&#10;    def put(self, request):&#10;        data = decode_body(request)&#10;        user_id = request.user.pk&#10;&#10;        project_id = data.get('project_id')&#10;        title = data.get('title')&#10;        description = data.get('description', '')&#10;        start_date = data.get('start_date')&#10;        end_date = data.get('end_date')&#10;        status = data.get('status')&#10;&#10;        # Basic Validation&#10;        if not project_id or not title or not start_date or not end_date:&#10;            return JsonResponse({&#10;                'success': False,&#10;                'error': 'Project ID, Title, and Dates are required.'&#10;            }, status=400)&#10;&#10;        try:&#10;            with connection.cursor() as cursor:&#10;                # Signature: (p_project_id, p_user_id, p_title, p_description, p_start_date, p_end_date,status)&#10;                cursor.callproc(&#10;                    &quot;update_project&quot;,&#10;                    [project_id, user_id, title, description, start_date, end_date, status]&#10;                )&#10;&#10;                # The procedure returns True (Success) or False (Not Leader/Failed)&#10;                success = cursor.fetchone()[0]&#10;&#10;                if success:&#10;                    return JsonResponse({'success': True, 'message': 'Project updated successfully'})&#10;                else:&#10;                    return JsonResponse({&#10;                        'success': False,&#10;                        'error': 'Permission denied. Only the Leader can edit this project.'&#10;                    }, status=403)&#10;&#10;        except Exception as e:&#10;            print(f&quot;Update Project Error: {e}&quot;)&#10;            return JsonResponse({'success': False, 'error': str(e)}, status=500)&#10;&#10;@method_decorator(csrf_exempt, name='dispatch')&#10;class ProjectMembershipView(View):&#10;    def dispatch(self, request, *args, **kwargs):&#10;        if not request.user.is_authenticated:&#10;            return JsonResponse({'success': False, 'error': 'Unauthorized'}, status=401)&#10;        return super().dispatch(request, *args, **kwargs)&#10;    # add a user to project&#10;    def post(self, request):&#10;        data = decode_body(request)&#10;        requester_id = request.user.pk&#10;&#10;        # Parse inputs&#10;        project_id = data.get('project_id')&#10;        identifier = data.get('identifier')&#10;        role = data.get('role', 'Member')  # Default to 'Member' if not provided&#10;&#10;        # Basic Validation&#10;        if not project_id or not identifier:&#10;            return JsonResponse({'success': False, 'error': 'Project ID and Username/Email are required.'}, status=400)&#10;&#10;        try:&#10;            with connection.cursor() as cursor:&#10;                # Signature: (p_project_id, p_requester_id, p_identifier, p_role)&#10;                cursor.callproc(&#10;                    &quot;add_project_member&quot;,&#10;                    [project_id, requester_id, identifier, role]&#10;                )&#10;&#10;                result = cursor.fetchone()[0]&#10;&#10;                if result.get('success'):&#10;                    return JsonResponse(result, status=201)&#10;                else:&#10;                    # Return 400 or 403 depending on the error, but 400 is generally fine here&#10;                    return JsonResponse(result, status=400)&#10;&#10;        except Exception as e:&#10;            print(f&quot;Add Member Error: {e}&quot;)&#10;            return JsonResponse({'success': False, 'error': 'Internal Server Error'}, status=500)&#10;    # remove a user fron project&#10;    def delete(self, request):&#10;        data = decode_body(request)&#10;        requester_id = request.user.pk&#10;&#10;        project_id = data.get('project_id')&#10;        target_user_id = data.get('user_id')&#10;&#10;        # Basic Validation&#10;        if not project_id or not target_user_id:&#10;            return JsonResponse({'success': False, 'error': 'Project ID and Target User ID are required.'}, status=400)&#10;&#10;        try:&#10;            with connection.cursor() as cursor:&#10;                # Signature: (p_project_id, p_requester_id, p_target_user_id)&#10;                cursor.callproc(&#10;                    &quot;remove_project_member&quot;,&#10;                    [project_id, requester_id, target_user_id]&#10;                )&#10;&#10;                # Fetch result&#10;                result = cursor.fetchone()[0]&#10;&#10;                if result.get('success'):&#10;                    return JsonResponse(result)&#10;                else:&#10;                    # Return 403 Forbidden if permission/safety check failed&#10;                    return JsonResponse(result, status=403)&#10;&#10;        except Exception as e:&#10;            print(f&quot;Remove Member Error: {e}&quot;)&#10;            return JsonResponse({'success': False, 'error': 'Internal Server Error'}, status=500)&#10;    # change user role in project&#10;    def put(self, request):&#10;        data = decode_body(request)&#10;        requester_id = request.user.pk  # The logged-in user (must be Leader)&#10;&#10;        # Parse inputs&#10;        project_id = data.get('project_id')&#10;        target_user_id = data.get('user_id')  # The user receiving the role change&#10;        new_role = data.get('role')&#10;&#10;        # Basic Validation&#10;        if not all([project_id, target_user_id, new_role]):&#10;            return JsonResponse({'success': False, 'error': 'Project ID, Target User ID, and Role are required.'},&#10;                                status=400)&#10;&#10;        valid_roles = ['Leader', 'Manager', 'Member']&#10;        if new_role not in valid_roles:&#10;            return JsonResponse({'success': False, 'error': 'Invalid role choice.'}, status=400)&#10;&#10;        try:&#10;            with connection.cursor() as cursor:&#10;                # Call Stored Procedure&#10;                # Signature: (p_project_id, p_requester_id, p_target_user_id, p_new_role)&#10;                cursor.callproc(&#10;                    &quot;update_project_member_role&quot;,&#10;                    [project_id, requester_id, target_user_id, new_role]&#10;                )&#10;&#10;                # The SP returns a JSON object directly&#10;                result = cursor.fetchone()[0]&#10;&#10;                # Check the 'success' key from the returned JSON&#10;                if result.get('success'):&#10;                    return JsonResponse(result)&#10;                else:&#10;                    # Return 403 Forbidden if permission/safety check failed&#10;                    return JsonResponse(result, status=403)&#10;&#10;        except Exception as e:&#10;            print(f&quot;Update Role Error: {e}&quot;)&#10;            return JsonResponse({'success': False, 'error': 'Internal Server Error'}, status=500)&#10;&#10;@method_decorator(csrf_exempt, name='dispatch')&#10;class TagView(View):&#10;    def dispatch(self, request, *args, **kwargs):&#10;        if not request.user.is_authenticated:&#10;            return JsonResponse({'success': False, 'error': 'Unauthorized'}, status=401)&#10;        return super().dispatch(request, *args, **kwargs)&#10;    # create tag&#10;    def post(self, request):&#10;        data = decode_body(request)&#10;        project_id = data.get('project_id')&#10;        name = data.get('name')&#10;        hex_color = data.get('hex_color', '#000000')&#10;&#10;        if not project_id or not name:&#10;            return JsonResponse({'success': False, 'error': 'Project ID and Name are required.'}, status=400)&#10;&#10;        try:&#10;            # PERMISSION CHECK: Must be Leader or Manager&#10;            has_permission = ProjectMembership.objects.filter(&#10;                project_id=project_id,&#10;                user_id=request.user.pk,&#10;                role__in=['Leader', 'Manager']  # &lt;--- Strict Check&#10;            ).exists()&#10;&#10;            if not has_permission:&#10;                return JsonResponse({'success': False, 'error': 'Only Leaders or Managers can create tags.'},&#10;                                    status=403)&#10;&#10;            # Create&#10;            tag = Tag.objects.create(&#10;                project_id=project_id,&#10;                name=name,&#10;                hex_color=hex_color&#10;            )&#10;&#10;            return JsonResponse({&#10;                'success': True,&#10;                'tag': {'tag_id': tag.tag_id, 'name': tag.name, 'hex_color': tag.hex_color}&#10;            }, status=201)&#10;&#10;        except Exception as e:&#10;            return JsonResponse({'success': False, 'error': str(e)}, status=500)&#10;    # edit tag&#10;    def put(self, request):&#10;        data = decode_body(request)&#10;        tag_id = data.get('tag_id')&#10;        name = data.get('name')&#10;        hex_color = data.get('hex_color')&#10;&#10;        if not tag_id:&#10;            return JsonResponse({'success': False, 'error': 'Tag ID is required.'}, status=400)&#10;&#10;        try:&#10;            tag = Tag.objects.get(pk=tag_id)&#10;&#10;            # PERMISSION CHECK&#10;            has_permission = ProjectMembership.objects.filter(&#10;                project_id=tag.project_id,&#10;                user_id=request.user.pk,&#10;                role__in=['Leader', 'Manager']&#10;            ).exists()&#10;&#10;            if not has_permission:&#10;                return JsonResponse({'success': False, 'error': 'Only Leaders or Managers can edit tags.'}, status=403)&#10;&#10;            if name:&#10;                tag.name = name&#10;            if hex_color:&#10;                tag.hex_color = hex_color&#10;&#10;            tag.save()&#10;&#10;            return JsonResponse({'success': True, 'message': 'Tag updated successfully.'})&#10;&#10;        except Tag.DoesNotExist:&#10;            return JsonResponse({'success': False, 'error': 'Tag not found.'}, status=404)&#10;        except Exception as e:&#10;            return JsonResponse({'success': False, 'error': str(e)}, status=500)&#10;    # delete tag&#10;    def delete(self, request):&#10;        data = decode_body(request)&#10;        tag_id = data.get('tag_id')&#10;&#10;        if not tag_id:&#10;            return JsonResponse({'success': False, 'error': 'Tag ID is required.'}, status=400)&#10;&#10;        try:&#10;            tag = Tag.objects.get(pk=tag_id)&#10;&#10;            # PERMISSION CHECK&#10;            has_permission = ProjectMembership.objects.filter(&#10;                project_id=tag.project_id,&#10;                user_id=request.user.pk,&#10;                role__in=['Leader', 'Manager']&#10;            ).exists()&#10;&#10;            if not has_permission:&#10;                return JsonResponse({'success': False, 'error': 'Only Leaders or Managers can delete tags.'}, status=403)&#10;&#10;            tag.delete()&#10;&#10;            return JsonResponse({'success': True, 'message': 'Tag deleted successfully.'})&#10;&#10;        except Tag.DoesNotExist:&#10;            return JsonResponse({'success': False, 'error': 'Tag not found.'}, status=404)&#10;        except Exception as e:&#10;            return JsonResponse({'success': False, 'error': str(e)}, status=500)&#10;" />
              <option name="updatedContent" value="import json&#10;from django.contrib.auth.decorators import login_required&#10;from django.db import connection&#10;from django.http import JsonResponse&#10;from django.utils.decorators import method_decorator&#10;from django.views.decorators.csrf import csrf_exempt&#10;from django.views import View&#10;from django.apps import apps&#10;&#10;from .models import *&#10;User = apps.get_model(app_label='user_app', model_name='User')&#10;Task = apps.get_model(app_label='task_app', model_name='Task')&#10;&#10;def decode_body(request):&#10;    try:&#10;        return json.loads(request.body.decode('utf-8'))&#10;    except json.JSONDecodeError:&#10;        return {}&#10;&#10;@method_decorator(csrf_exempt, name='dispatch')&#10;class ProjectView(View):&#10;    def dispatch(self, request, *args, **kwargs):&#10;        if not request.user.is_authenticated:&#10;            return JsonResponse({'success': False, 'error': 'Unauthorized'}, status=401)&#10;        return super().dispatch(request, *args, **kwargs)&#10;    def get(self, request):&#10;        user_id = request.user.pk&#10;&#10;        filter_type = request.GET.get('filter', 'Active')&#10;&#10;        # Validate filter to prevent SQL issues (optional but good practice)&#10;        valid_filters = ['Active', 'Archived', 'Complete', 'All', 'Leader']&#10;        if filter_type not in valid_filters:&#10;            filter_type = 'Active'&#10;&#10;        try:&#10;            with connection.cursor() as cursor:&#10;                # Call the Stored Procedure&#10;                cursor.callproc(&quot;get_user_projects&quot;, [user_id, filter_type])&#10;&#10;                # Fetch the JSON result&#10;                projects_data = cursor.fetchone()[0]&#10;&#10;                return JsonResponse({'success': True, 'projects': projects_data})&#10;&#10;        except Exception as e:&#10;            print(f&quot;Get Projects Error: {e}&quot;)&#10;            return JsonResponse({'success': False, 'error': 'Internal Server Error'}, status=500)&#10;    def post(self, request):&#10;        data = decode_body(request)&#10;&#10;        # Extract data from the request body&#10;        user_id = request.user.pk&#10;        title = data.get('title')&#10;        description = data.get('description', '')  # Default to empty string if missing&#10;        start_date = data.get('start_date')&#10;        end_date = data.get('end_date')&#10;&#10;        # Basic Validation&#10;        if not title or not start_date or not end_date:&#10;            return JsonResponse({&#10;                'success': False,&#10;                'error': 'Title, Start Date, and End Date are required.'&#10;            }, status=400)&#10;&#10;        try:&#10;            with connection.cursor() as cursor:&#10;                # Signature: (p_user_id, p_title, p_description, p_start_date, p_end_date)&#10;                cursor.callproc(&#10;                    &quot;create_project&quot;,&#10;                    [user_id, title, description, start_date, end_date]&#10;                )&#10;&#10;                # Fetch the returned Project ID&#10;                new_project_id = cursor.fetchone()[0]&#10;&#10;                return JsonResponse({&#10;                    'success': True,&#10;                    'message': 'Project created successfully',&#10;                    'project_id': new_project_id&#10;                }, status=201)&#10;&#10;        except Exception as e:&#10;            # Log error for debugging (optional)&#10;            print(f&quot;Create Project Error: {e}&quot;)&#10;            return JsonResponse({'success': False, 'error': str(e)}, status=500)&#10;    def delete(self, request):&#10;        user_id = request.user.pk&#10;&#10;        data = decode_body(request)&#10;        project_id = data.get('project_id')&#10;&#10;        if not project_id:&#10;            return JsonResponse({'success': False, 'error': 'Project ID is required'}, status=400)&#10;&#10;        try:&#10;            # 1. Security Check: Only the 'Leader' can delete&#10;            # We check if a membership exists that matches: User + Project + Role='Leader'&#10;            is_leader = ProjectMembership.objects.filter(&#10;                project_id=project_id,&#10;                user_id=user_id,&#10;                role='Leader'&#10;            ).exists()&#10;&#10;            if not is_leader:&#10;                return JsonResponse({&#10;                    'success': False,&#10;                    'error': 'Permission denied. Only the Leader can delete this project.'&#10;                }, status=403)&#10;&#10;            # 2. Perform Delete&#10;            Project.objects.get(pk=project_id).delete()&#10;&#10;            return JsonResponse({'success': True, 'message': 'Project deleted successfully'})&#10;&#10;        except Project.DoesNotExist:&#10;            return JsonResponse({'success': False, 'error': 'Project not found'}, status=404)&#10;        except Exception as e:&#10;            return JsonResponse({'success': False, 'error': str(e)}, status=500)&#10;&#10;@method_decorator(csrf_exempt, name='dispatch')&#10;class ProjectDetailView(View):&#10;    def dispatch(self, request, *args, **kwargs):&#10;        if not request.user.is_authenticated:&#10;            return JsonResponse({'success': False, 'error': 'Unauthorized'}, status=401)&#10;        return super().dispatch(request, *args, **kwargs)&#10;    # get project details&#10;    def get(self, request):&#10;        project_id = request.GET.get('project_id')&#10;        user_id = request.user.pk&#10;&#10;        if not project_id:&#10;            return JsonResponse({'success': False, 'error': 'Project ID is required.'}, status=400)&#10;&#10;        try:&#10;            with connection.cursor() as cursor:&#10;                # Call Stored Procedure&#10;                # Signature: (p_project_id, p_user_id)&#10;                cursor.callproc(&#10;                    &quot;get_project_details&quot;,&#10;                    [project_id, user_id]&#10;                )&#10;&#10;                # Fetch the single JSON blob result&#10;                result = cursor.fetchone()[0]&#10;&#10;                # Check status code based on result success&#10;                if result.get('success'):&#10;                    return JsonResponse(result)&#10;                else:&#10;                    # Determine error code (403 for Unauthorized, 404 for Not Found)&#10;                    error_msg = result.get('error', '')&#10;                    status_code = 403 if 'Unauthorized' in error_msg else 404&#10;                    return JsonResponse(result, status=status_code)&#10;&#10;        except Exception as e:&#10;            print(f&quot;Get Project Details Error: {e}&quot;)&#10;            return JsonResponse({'success': False, 'error': 'Internal Server Error'}, status=500)&#10;    # update project details&#10;    def put(self, request):&#10;        data = decode_body(request)&#10;        user_id = request.user.pk&#10;&#10;        project_id = data.get('project_id')&#10;        title = data.get('title')&#10;        description = data.get('description', '')&#10;        start_date = data.get('start_date')&#10;        end_date = data.get('end_date')&#10;        status = data.get('status')&#10;&#10;        # Basic Validation&#10;        if not project_id or not title or not start_date or not end_date:&#10;            return JsonResponse({&#10;                'success': False,&#10;                'error': 'Project ID, Title, and Dates are required.'&#10;            }, status=400)&#10;&#10;        try:&#10;            with connection.cursor() as cursor:&#10;                # Signature: (p_project_id, p_user_id, p_title, p_description, p_start_date, p_end_date,status)&#10;                cursor.callproc(&#10;                    &quot;update_project&quot;,&#10;                    [project_id, user_id, title, description, start_date, end_date, status]&#10;                )&#10;&#10;                # The procedure returns True (Success) or False (Not Leader/Failed)&#10;                success = cursor.fetchone()[0]&#10;&#10;                if success:&#10;                    return JsonResponse({'success': True, 'message': 'Project updated successfully'})&#10;                else:&#10;                    return JsonResponse({&#10;                        'success': False,&#10;                        'error': 'Permission denied. Only the Leader can edit this project.'&#10;                    }, status=403)&#10;&#10;        except Exception as e:&#10;            print(f&quot;Update Project Error: {e}&quot;)&#10;            return JsonResponse({'success': False, 'error': str(e)}, status=500)&#10;&#10;@method_decorator(csrf_exempt, name='dispatch')&#10;class ProjectMembershipView(View):&#10;    def dispatch(self, request, *args, **kwargs):&#10;        if not request.user.is_authenticated:&#10;            return JsonResponse({'success': False, 'error': 'Unauthorized'}, status=401)&#10;        return super().dispatch(request, *args, **kwargs)&#10;    # add a user to project&#10;    def post(self, request):&#10;        data = decode_body(request)&#10;        requester_id = request.user.pk&#10;&#10;        # Parse inputs&#10;        project_id = data.get('project_id')&#10;        identifier = data.get('identifier')&#10;        role = data.get('role', 'Member')  # Default to 'Member' if not provided&#10;&#10;        # Basic Validation&#10;        if not project_id or not identifier:&#10;            return JsonResponse({'success': False, 'error': 'Project ID and Username/Email are required.'}, status=400)&#10;&#10;        try:&#10;            with connection.cursor() as cursor:&#10;                # Signature: (p_project_id, p_requester_id, p_identifier, p_role)&#10;                cursor.callproc(&#10;                    &quot;add_project_member&quot;,&#10;                    [project_id, requester_id, identifier, role]&#10;                )&#10;&#10;                result = cursor.fetchone()[0]&#10;&#10;                if result.get('success'):&#10;                    return JsonResponse(result, status=201)&#10;                else:&#10;                    # Return 400 or 403 depending on the error, but 400 is generally fine here&#10;                    return JsonResponse(result, status=400)&#10;&#10;        except Exception as e:&#10;            print(f&quot;Add Member Error: {e}&quot;)&#10;            return JsonResponse({'success': False, 'error': 'Internal Server Error'}, status=500)&#10;    # remove a user fron project&#10;    def delete(self, request):&#10;        data = decode_body(request)&#10;        requester_id = request.user.pk&#10;&#10;        project_id = data.get('project_id')&#10;        target_user_id = data.get('user_id')&#10;&#10;        # Basic Validation&#10;        if not project_id or not target_user_id:&#10;            return JsonResponse({'success': False, 'error': 'Project ID and Target User ID are required.'}, status=400)&#10;&#10;        try:&#10;            with connection.cursor() as cursor:&#10;                # Signature: (p_project_id, p_requester_id, p_target_user_id)&#10;                cursor.callproc(&#10;                    &quot;remove_project_member&quot;,&#10;                    [project_id, requester_id, target_user_id]&#10;                )&#10;&#10;                # Fetch result&#10;                result = cursor.fetchone()[0]&#10;&#10;                if result.get('success'):&#10;                    return JsonResponse(result)&#10;                else:&#10;                    # Return 403 Forbidden if permission/safety check failed&#10;                    return JsonResponse(result, status=403)&#10;&#10;        except Exception as e:&#10;            print(f&quot;Remove Member Error: {e}&quot;)&#10;            return JsonResponse({'success': False, 'error': 'Internal Server Error'}, status=500)&#10;    # change user role in project&#10;    def put(self, request):&#10;        data = decode_body(request)&#10;        requester_id = request.user.pk  # The logged-in user (must be Leader)&#10;&#10;        # Parse inputs&#10;        project_id = data.get('project_id')&#10;        target_user_id = data.get('user_id')  # The user receiving the role change&#10;        new_role = data.get('role')&#10;&#10;        # Basic Validation&#10;        if not all([project_id, target_user_id, new_role]):&#10;            return JsonResponse({'success': False, 'error': 'Project ID, Target User ID, and Role are required.'},&#10;                                status=400)&#10;&#10;        valid_roles = ['Leader', 'Manager', 'Member']&#10;        if new_role not in valid_roles:&#10;            return JsonResponse({'success': False, 'error': 'Invalid role choice.'}, status=400)&#10;&#10;        try:&#10;            with connection.cursor() as cursor:&#10;                # Call Stored Procedure&#10;                # Signature: (p_project_id, p_requester_id, p_target_user_id, p_new_role)&#10;                cursor.callproc(&#10;                    &quot;update_project_member_role&quot;,&#10;                    [project_id, requester_id, target_user_id, new_role]&#10;                )&#10;&#10;                # The SP returns a JSON object directly&#10;                result = cursor.fetchone()[0]&#10;&#10;                # Check the 'success' key from the returned JSON&#10;                if result.get('success'):&#10;                    return JsonResponse(result)&#10;                else:&#10;                    # Return 403 Forbidden if permission/safety check failed&#10;                    return JsonResponse(result, status=403)&#10;&#10;        except Exception as e:&#10;            print(f&quot;Update Role Error: {e}&quot;)&#10;            return JsonResponse({'success': False, 'error': 'Internal Server Error'}, status=500)&#10;&#10;@method_decorator(csrf_exempt, name='dispatch')&#10;class TagView(View):&#10;    def dispatch(self, request, *args, **kwargs):&#10;        if not request.user.is_authenticated:&#10;            return JsonResponse({'success': False, 'error': 'Unauthorized'}, status=401)&#10;        return super().dispatch(request, *args, **kwargs)&#10;    # create tag&#10;    def post(self, request):&#10;        data = decode_body(request)&#10;        project_id = data.get('project_id')&#10;        name = data.get('name')&#10;        hex_color = data.get('hex_color', '#000000')&#10;&#10;        if not project_id or not name:&#10;            return JsonResponse({'success': False, 'error': 'Project ID and Name are required.'}, status=400)&#10;&#10;        try:&#10;            # PERMISSION CHECK: Must be Leader or Manager&#10;            has_permission = ProjectMembership.objects.filter(&#10;                project_id=project_id,&#10;                user_id=request.user.pk,&#10;                role__in=['Leader', 'Manager']  # &lt;--- Strict Check&#10;            ).exists()&#10;&#10;            if not has_permission:&#10;                return JsonResponse({'success': False, 'error': 'Only Leaders or Managers can create tags.'},&#10;                                    status=403)&#10;&#10;            # Create&#10;            tag = Tag.objects.create(&#10;                project_id=project_id,&#10;                name=name,&#10;                hex_color=hex_color&#10;            )&#10;&#10;            return JsonResponse({&#10;                'success': True,&#10;                'tag': {'tag_id': tag.tag_id, 'name': tag.name, 'hex_color': tag.hex_color}&#10;            }, status=201)&#10;&#10;        except Exception as e:&#10;            return JsonResponse({'success': False, 'error': str(e)}, status=500)&#10;    # edit tag&#10;    def put(self, request):&#10;        data = decode_body(request)&#10;        tag_id = data.get('tag_id')&#10;        name = data.get('name')&#10;        hex_color = data.get('hex_color')&#10;&#10;        if not tag_id:&#10;            return JsonResponse({'success': False, 'error': 'Tag ID is required.'}, status=400)&#10;&#10;        try:&#10;            tag = Tag.objects.get(pk=tag_id)&#10;&#10;            # PERMISSION CHECK&#10;            has_permission = ProjectMembership.objects.filter(&#10;                project_id=tag.project_id,&#10;                user_id=request.user.pk,&#10;                role__in=['Leader', 'Manager']&#10;            ).exists()&#10;&#10;            if not has_permission:&#10;                return JsonResponse({'success': False, 'error': 'Only Leaders or Managers can edit tags.'}, status=403)&#10;&#10;            if name:&#10;                tag.name = name&#10;            if hex_color:&#10;                tag.hex_color = hex_color&#10;&#10;            tag.save()&#10;&#10;            return JsonResponse({'success': True, 'message': 'Tag updated successfully.'})&#10;&#10;        except Tag.DoesNotExist:&#10;            return JsonResponse({'success': False, 'error': 'Tag not found.'}, status=404)&#10;        except Exception as e:&#10;            return JsonResponse({'success': False, 'error': str(e)}, status=500)&#10;    # delete tag&#10;    def delete(self, request):&#10;        data = decode_body(request)&#10;        tag_id = data.get('tag_id')&#10;&#10;        if not tag_id:&#10;            return JsonResponse({'success': False, 'error': 'Tag ID is required.'}, status=400)&#10;&#10;        try:&#10;            tag = Tag.objects.get(pk=tag_id)&#10;&#10;            # PERMISSION CHECK&#10;            has_permission = ProjectMembership.objects.filter(&#10;                project_id=tag.project_id,&#10;                user_id=request.user.pk,&#10;                role__in=['Leader', 'Manager']&#10;            ).exists()&#10;&#10;            if not has_permission:&#10;                return JsonResponse({'success': False, 'error': 'Only Leaders or Managers can delete tags.'}, status=403)&#10;&#10;            tag.delete()&#10;&#10;            return JsonResponse({'success': True, 'message': 'Tag deleted successfully.'})&#10;&#10;        except Tag.DoesNotExist:&#10;            return JsonResponse({'success': False, 'error': 'Tag not found.'}, status=404)&#10;        except Exception as e:&#10;            return JsonResponse({'success': False, 'error': str(e)}, status=500)" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/backend/dunzomanagement/user_app/views.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/backend/dunzomanagement/user_app/views.py" />
              <option name="originalContent" value="import json&#10;from django.contrib.auth import logout&#10;from django.contrib.auth.decorators import login_required&#10;from django.db import connection&#10;from django.http import JsonResponse&#10;from django.shortcuts import get_object_or_404&#10;from django.utils.decorators import method_decorator&#10;from django.views.decorators.csrf import csrf_exempt&#10;from django.views import View&#10;from django.apps import apps&#10;&#10;from .models import Notification&#10;Task = apps.get_model(app_label='task_app', model_name='Task')&#10;Project = apps.get_model(app_label='project_app', model_name='Project')&#10;CalendarEvent = apps.get_model(app_label='calendarevent_app', model_name='CalendarEvent')&#10;&#10;&#10;def decode_body(request):&#10;    try:&#10;        return json.loads(request.body.decode('utf-8'))&#10;    except json.JSONDecodeError:&#10;        return {}&#10;&#10;@login_required&#10;def get_dashboard(request):&#10;    user_id = request.user.pk&#10;&#10;    try:&#10;        with connection.cursor() as cursor:&#10;            cursor.callproc(&quot;get_user_dashboard_data&quot;, [user_id])&#10;&#10;            # Fetch the result (returns a tuple, we want the first element)&#10;            row = cursor.fetchone()&#10;&#10;            if row and row[0]:&#10;                result = row[0]&#10;                return JsonResponse(result, safe=False)&#10;            else:&#10;                # Handle case where procedure returns NULL (shouldn't happen with this SQL)&#10;                return JsonResponse({'error': 'No data returned'}, status=500)&#10;&#10;    except Exception as e:&#10;        # Log the specific error for debugging&#10;        print(f&quot;Dashboard Stored Procedure Error: {e}&quot;)&#10;        return JsonResponse({'error': 'Internal Server Error'}, status=500)&#10;&#10;@method_decorator(csrf_exempt, name='dispatch')&#10;class UserView(View):&#10;    def dispatch(self, request, *args, **kwargs):&#10;        if not request.user.is_authenticated:&#10;            return JsonResponse({'success': False, 'error': 'Unauthorized'}, status=401)&#10;        return super().dispatch(request, *args, **kwargs)&#10;&#10;    # settings&#10;    def get(self, request):&#10;        user = request.user&#10;        user_data = {&#10;            &quot;user_id&quot;: user.pk,&#10;            &quot;username&quot;: user.username,&#10;            &quot;email&quot;: user.email,&#10;            &quot;first_name&quot;: user.first_name,&#10;            &quot;last_name&quot;: user.last_name,&#10;        }&#10;        return JsonResponse(user_data)&#10;    # edit user details&#10;    def put(self, request):&#10;        data = decode_body(request)&#10;        user = request.user&#10;&#10;        # Update fields if they are provided in the request&#10;        user.username = data.get('username', user.username)&#10;        user.email = data.get('email', user.email)&#10;        user.first_name = data.get('first_name', user.first_name)&#10;        user.last_name = data.get('last_name', user.last_name)&#10;&#10;        # If password is provided, update it (make sure to hash it)&#10;        new_password = data.get('password')&#10;        if new_password:&#10;            user.set_password(new_password)&#10;&#10;        try:&#10;            user.save()&#10;            return JsonResponse({'success': True, 'message': 'User updated successfully'})&#10;        except Exception as e:&#10;            # Catch errors like &quot;Username already taken&quot;&#10;            return JsonResponse({'success': False, 'error': str(e)}, status=400)&#10;    # delete user&#10;    def delete(self, request):&#10;        user = request.user&#10;        user.delete()&#10;        logout(request)&#10;        return JsonResponse({'success': True, 'message': 'User deleted successfully'})&#10;&#10;@method_decorator(csrf_exempt, name='dispatch')&#10;class NotificationView(View):&#10;    def dispatch(self, request, *args, **kwargs):&#10;        if not request.user.is_authenticated:&#10;            return JsonResponse({'success': False, 'error': 'Unauthorized'}, status=401)&#10;        return super().dispatch(request, *args, **kwargs)&#10;&#10;    def get(self, request):&#10;        user = request.user.pk&#10;        notifs = Notification.objects.filter(user=user).order_by('-created_at')&#10;        notif_list = [&#10;            {&#10;                &quot;notification_id&quot;: n.pk,&#10;                &quot;title&quot;: n.title,&#10;                &quot;message&quot;: n.message,&#10;                &quot;is_read&quot;: n.is_read,&#10;                &quot;created_at&quot;: n.created_at,&#10;            }&#10;            for n in notifs&#10;        ]&#10;        return JsonResponse(notif_list, safe=False)&#10;&#10;    def delete(self, request, notification_id):&#10;        notif = get_object_or_404(Notification, pk=notification_id, user=request.user.pk)&#10;        notif.delete()&#10;        return JsonResponse({'success': True, 'message': 'Notification deleted successfully'})" />
              <option name="updatedContent" value="import json&#10;from django.contrib.auth import logout&#10;from django.contrib.auth.decorators import login_required&#10;from django.db import connection&#10;from django.http import JsonResponse&#10;from django.shortcuts import get_object_or_404&#10;from django.utils.decorators import method_decorator&#10;from django.views.decorators.csrf import csrf_exempt&#10;from django.views import View&#10;from django.apps import apps&#10;&#10;from .models import Notification&#10;Task = apps.get_model(app_label='task_app', model_name='Task')&#10;Project = apps.get_model(app_label='project_app', model_name='Project')&#10;CalendarEvent = apps.get_model(app_label='calendarevent_app', model_name='CalendarEvent')&#10;&#10;&#10;def decode_body(request):&#10;    try:&#10;        return json.loads(request.body.decode('utf-8'))&#10;    except json.JSONDecodeError:&#10;        return {}&#10;&#10;@login_required&#10;def get_dashboard(request):&#10;    user_id = request.user.pk&#10;&#10;    try:&#10;        with connection.cursor() as cursor:&#10;            cursor.callproc(&quot;get_user_dashboard_data&quot;, [user_id])&#10;&#10;            # Fetch the result (returns a tuple, we want the first element)&#10;            row = cursor.fetchone()&#10;&#10;            if row and row[0]:&#10;                result = row[0]&#10;                return JsonResponse(result, safe=False)&#10;            else:&#10;                # Handle case where procedure returns NULL (shouldn't happen with this SQL)&#10;                return JsonResponse({'error': 'No data returned'}, status=500)&#10;&#10;    except Exception as e:&#10;        # Log the specific error for debugging&#10;        print(f&quot;Dashboard Stored Procedure Error: {e}&quot;)&#10;        return JsonResponse({'error': 'Internal Server Error'}, status=500)&#10;&#10;@method_decorator(csrf_exempt, name='dispatch')&#10;class UserView(View):&#10;    def dispatch(self, request, *args, **kwargs):&#10;        if not request.user.is_authenticated:&#10;            return JsonResponse({'success': False, 'error': 'Unauthorized'}, status=401)&#10;        return super().dispatch(request, *args, **kwargs)&#10;&#10;    # settings&#10;    def get(self, request):&#10;        user = request.user&#10;        user_data = {&#10;            &quot;user_id&quot;: user.pk,&#10;            &quot;username&quot;: user.username,&#10;            &quot;email&quot;: user.email,&#10;            &quot;first_name&quot;: user.first_name,&#10;            &quot;last_name&quot;: user.last_name,&#10;        }&#10;        return JsonResponse(user_data)&#10;    # edit user details&#10;    def put(self, request):&#10;        data = decode_body(request)&#10;        user = request.user&#10;&#10;        # Update fields if they are provided in the request&#10;        user.username = data.get('username', user.username)&#10;        user.email = data.get('email', user.email)&#10;        user.first_name = data.get('first_name', user.first_name)&#10;        user.last_name = data.get('last_name', user.last_name)&#10;&#10;        # If password is provided, update it (make sure to hash it)&#10;        new_password = data.get('password')&#10;        if new_password:&#10;            user.set_password(new_password)&#10;&#10;        try:&#10;            user.save()&#10;            return JsonResponse({'success': True, 'message': 'User updated successfully'})&#10;        except Exception as e:&#10;            # Catch errors like &quot;Username already taken&quot;&#10;            return JsonResponse({'success': False, 'error': str(e)}, status=400)&#10;    # delete user&#10;    def delete(self, request):&#10;        user = request.user&#10;        user.delete()&#10;        logout(request)&#10;        return JsonResponse({'success': True, 'message': 'User deleted successfully'})&#10;&#10;@method_decorator(csrf_exempt, name='dispatch')&#10;class NotificationView(View):&#10;    def dispatch(self, request, *args, **kwargs):&#10;        if not request.user.is_authenticated:&#10;            return JsonResponse({'success': False, 'error': 'Unauthorized'}, status=401)&#10;        return super().dispatch(request, *args, **kwargs)&#10;&#10;    def get(self, request):&#10;        user = request.user.pk&#10;        notifs = Notification.objects.filter(user=user).order_by('-created_at')&#10;        notif_list = [&#10;            {&#10;                &quot;notification_id&quot;: n.pk,&#10;                &quot;title&quot;: n.title,&#10;                &quot;message&quot;: n.message,&#10;                &quot;is_read&quot;: n.is_read,&#10;                &quot;created_at&quot;: n.created_at,&#10;            }&#10;            for n in notifs&#10;        ]&#10;        return JsonResponse(notif_list, safe=False)&#10;&#10;    def delete(self, request, notification_id):&#10;        notif = get_object_or_404(Notification, pk=notification_id, user=request.user.pk)&#10;        notif.delete()&#10;        return JsonResponse({'success': True, 'message': 'Notification deleted successfully'})" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>